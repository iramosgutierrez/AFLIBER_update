---
title: "AFLIBER - Create New Version (AFLIBER2.0)"
output: html_document
date: "2025-10-13"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(here)

source(here::here("R/AFLIBER_functions.R"))
```

## 1. Regeneración de la lista de especies

Para esta versión AFLIBER2 no se ha realizado, dado que el listado de nombres ha de utilizarse en la extracción de datos desde los datasets iniciales, y esto se ha hecho utilizando el listado original en AFLIBER v1.

Sin embargo, en futuras versiones sería importante integrarlo, ya que es la manera de generar un dataset con taxonomía y nomenclatura fluida.

Los único cambios nomenclaturales incluidos son: unión de las 2 subespecies de *Hedera*, y cambio de *Hedera maderensis iberica* a *H. iberica*.

```{r checklist}
AFLIBER_specieslist_old <- read_csv(here("inst/AFLIBER/raw/AFLIBER_Species_list.csv"), show_col_types = F)

AFLIBER_specieslist_new <- AFLIBER_specieslist_old
# source(here::here("R/AFLIBER_1. Species list regeneration.R"))

print(AFLIBER_specieslist_new)
```


## 2. Recopilación de citas nuevas

Se incluyen todos los datasets que hayan sido incluidos como ramas nuevas en el repositorio de GitHub (cada rama tiene un citationkey identificador del dataset).

Se crea un dataset nuevo (`AFLIBER_novelties`), además de cargar los datos antiguos (`AFLIBER_distributions_old`)

```{r new_occurrences}


source(here("R/AFLIBER_2. merge_novelties.R"))

print(as_tibble(AFLIBER_novelties))
```

## 3. Referencias numéricas

Los nuevos datos tienen referencias bibliográficas incorporadas como texto que tienen que incluirse en la tabla de referencias numéricas. Además, hay que hacer algunas modificaciones individuales por asignaciones de referencias no existentes (muchas veces a causa de "arrastrar" en excel, generando *doi*s de números consecutivos).


```{r references}
source(here::here("R/AFLIBER_3. Reference numbers.R"))

new_sources |> 
  arrange(desc(`NUMBER OF OCCURRENCES`)) |> 
  as_tibble() |> 
  print()

# bind_rows(old_sources, new_sources) |> 
#   arrange(`NUMERIC REFERENCE`) |> 
#   write_csv(file = "AFLIBER_v2.0.0/AFLIBER_DataSources.csv")

```

## 4. Eliminación de errores
Por último, hay que eliminar todos los errores que se han ido detectando en los distintos procesos de limieza del dataset. Para evitar incluir errores que ya se detectaron en procesos previos, se combinan todos los datasets de corrección y luego se eliminan los registros.

Esto potencialmente puede conducir a la eliminación sistemática de una cita al estar en una cuadrícula descartada. En este caso, habría que eliminar esa corrección, pero al ser un criterio experto que tiene que estar convenientemente contrastado, lo mejor es hacerlo de este modo.

```{r errors}
source("R/AFLIBER_4. Occurrence corrections.R")
print(AFLIBER_distributions_complete)
```

## 5. Resumen de los datos incorporados
Podemos visualizar los mapas de riqueza de la primera y segunda versión; además de ver la distribución de datos de las novedades.

```{r maps}
source("R/AFLIBER_5. Summary.R")

old

new

diff
```

## 6. Crear mapas individuales

Generar mapas individuales para re-comprobaciones

```{r individual_maps, eval=F, include = F}
if(FALSE){ # To NOT RUN !!!
  
source("R/AFLIBER_6. Species_maps.R")

  }

```


